<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Sketch Extractor</title>
    <meta name="description" content="Makes white of an image transparent">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#282828">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html, body { height: 100%; position: relative; overflow-x: hidden; }
        body { font-family: sans-serif; background: #282828; color: white; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-size: 1rem; text-align: center; }
        canvas { image-rendering: pixelated; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2N89+7dfwYkICgoiMxlYKSDgv///6O44f3796huoL0CAPpyKx1ry0n4AAAAAElFTkSuQmCC') repeat top left; }
        button { height: 3rem; padding: 0 1rem; vertical-align: middle; background: white; border: 0; border-radius: 1.5rem; min-width: 3rem; line-height: 3rem; cursor: pointer; }
        .block { display: block; margin: 1rem auto; }
        input:not([type="checkbox"]):not([type="file"]) { vertical-align: middle; background: white; box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.5); border: 0; border-radius: .25rem; height: 3rem; width: calc(100% - 2rem); max-width: 16rem; }
        input.small:not([type="checkbox"]):not([type="file"]) { max-width: 3rem; }
        input.medium:not([type="checkbox"]):not([type="file"]) { max-width: 8rem; }
        input:not([type="checkbox"]):not([type="file"]):disabled { background: #828282; }
        a { color: white; }
        .color-patch { display: inline-block; vertical-align: middle; width: 3rem; height: 3rem; line-height: 3rem; border: 1px white solid; border-radius: .25rem; cursor: pointer; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2N89+7dfwYkICgoiMxlYKSDgv///6O44f3796huoL0CAPpyKx1ry0n4AAAAAElFTkSuQmCC') repeat top left; }
        .color-patch svg { width: 1rem; height: 1rem; margin: 1rem; filter: drop-shadow( 0px 0px 2px rgba(255, 255, 255, 1)); }
    </style>
</head>
<body>
<canvas id="canvas" class="block"></canvas>
<div class="block">
    <button onclick="window.location.hash = btoa(JSON.stringify(data)); copyStringToClipboard(window.location, this);">share</button>
    <button onclick="copyStringToClipboard(data.frames, this)">string</button>
    <button onclick="copyStringToClipboard(getCode(), this)">code</button>
    <a href="#" id="exportButton" download="spritesheet.png"><button>sheet</button></a>
</div>
<div class="block">
    <input type="file" onchange="handleFile(this)">
</div>
<div class="block">
    <a href="https://github.com/Quinten/sketch-extractor" target="_blank" rel="noopener">read me</a>
</div>
<script>

let frameWidth = 512;
let frameHeight = 512;

// the 2d drawing api
let ctx = canvas.getContext('2d');
//console.log(ctx);

// resize canvas with window
let wWidth = window.innerWidth;
let wHeight = window.innerHeight;
let onR = e => {
    canvas.width = frameWidth;
    canvas.height = frameHeight;
    let w = Math.min(wWidth - 40, wHeight / frameHeight * frameWidth - 40);
    let h = w / frameWidth * frameHeight;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
};
onR();
window.addEventListener('resize', e => {
    wWidth = window.innerWidth;
    wHeight = window.innerHeight;
    onR();
});

// register service worker for PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', e => {
        navigator.serviceWorker.register('./sw.js').then(registration => {
            //console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
            //console.log('ServiceWorker registration failed: ', err);
        });
    });
}

let handleFile = el => {
    let file = el.files[0];
    let fileReader = new FileReader();
    fileReader.addEventListener('load', _ => {
        let src = fileReader.result;
        let img = new Image();
        img.addEventListener('load', _ => {
            let nFramesW = Math.floor(img.width / frameWidth);
            let nFramesH = Math.floor(img.height / frameHeight);
            let nFrames = nFramesW * nFramesH;
            let frames = [];
            let colors = {};
            let num = 64;
            let tmpCanvas = document.createElement('canvas');
            let tmpCtx = tmpCanvas.getContext('2d');
            tmpCanvas.width = frameWidth;
            tmpCanvas.height = frameHeight;
            while(frames.length < nFrames) {
                let frame = '';
                let i = frames.length;
                let sx = i % nFramesW * frameWidth;
                let sy = Math.floor(i / nFramesW) * frameHeight;
                tmpCtx.clearRect(0, 0, frameWidth, frameHeight);
                tmpCtx.drawImage(img, sx, sy, frameWidth, frameHeight, 0, 0, frameWidth, frameHeight);
                while (frame.length < frameWidth * frameHeight) {
                    let px = frame.length % frameWidth;
                    let py = Math.floor(frame.length / frameWidth);
                    let [r, g, b, a] = tmpCtx.getImageData(px, py, 1, 1).data;
                    let color = '';
                    if (a === 0) {
                        color = 'transparent';
                    } else if (a === 255) {
                        color = '#' + r.toString(16) + g.toString(16) + b.toString(16);
                    } else {
                        color = `rgba(${r}, ${g}, ${b}, ${a/255})`;
                    }
                    let key = transparentKey;
                    if (color !== 'transparent') {
                        if (Object.keys(colors).map(c => colors[c]).indexOf(color) === -1) {
                            while (key === transparentKey) {
                                num = num + 1;
                                key = String.fromCharCode(num);
                                colors[key] = color;
                            }
                        } else {
                            key = Object.keys(colors).reduce((acc, k) => (colors[k] === color) ? k : acc);
                        }
                    }
                    frame = frame + key;
                }
                frames.push(encodedFrames(frame));
            }
            data.colors = colors;
            colorBlocks.innerHTML = '';
            Object.keys(data.colors).forEach(key => {
                colorBlocks.innerHTML = colorBlocks.innerHTML + getColorBlock(key, data.colors[key]);
            });
            data.frames = frames.join('|');
            data.currentFrame = data.currentFrame;
            data.nFramesWide = nFramesW;
        });
        img.src = src;
    }, false);
    fileReader.readAsDataURL(file);
};
});

</script>
</body>
</html>
